<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Tilt Test v8</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1a1a1a; overflow: hidden; touch-action: none; font-family: monospace; }
#gameCanvas { display: block; background: #0a0a0a; }
#startBtn {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    padding: 20px 60px; font-size: 24px; background: #009688; color: white;
    border: none; border-radius: 12px; cursor: pointer; z-index: 10;
}
#info { position: absolute; top: 16px; left: 16px; font-size: 16px; color: white; z-index: 5; line-height: 1.4; }
#version { position: absolute; bottom: 16px; right: 16px; font-size: 14px; color: rgba(255,255,255,0.5); }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="info">
    Version 8 (High Friction)<br>
    RelX: <span id="tiltX">0</span><br>
    RelY: <span id="tiltY">0</span><br>
    <span id="status" style="color: #00E676;">Press START and hold steady...</span>
</div>
<div id="version">v8.0</div>
<button id="startBtn">START</button>

<script>
const VERSION = 8;
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");

let gameRunning = false;
let tiltX = 0;
let tiltY = 0;
let baseGX = 0, baseGY = 0, baseGZ = 0;

// Physics Config
let dot = {
    x: 0, y: 0,
    vx: 0, vy: 0,
    radius: 20,
    friction: 0.85,    // High friction (v7 was 0.93)
    sensitivity: 0.3, // Lower sensitivity (v7 was 0.6)
    deadzone: 1.0     // Ignore small tilts (v7 was 0.4)
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

function handleMotion(e) {
    const acc = e.accelerationIncludingGravity;
    if (!acc) return;

    // Relative to baseline
    let dx = acc.x - baseGX;
    let dy = acc.y - baseGY;

    const rot = window.orientation || 0;
    if (rot === 0) {
        tiltX = -dx;
        tiltY = dy;
    } else if (rot === 90) {
        tiltX = dy;
        tiltY = dx;
    } else if (rot === -90) {
        tiltX = -dy;
        tiltY = -dx;
    }

    document.getElementById('tiltX').textContent = tiltX.toFixed(2);
    document.getElementById('tiltY').textContent = tiltY.toFixed(2);
}

function update() {
    if (!gameRunning) return;

    // Apply force only outside deadzone
    let forceX = Math.abs(tiltX) > dot.deadzone ? tiltX : 0;
    let forceY = Math.abs(tiltY) > dot.deadzone ? tiltY : 0;

    // Apply acceleration
    dot.vx += forceX * dot.sensitivity;
    dot.vy += forceY * dot.sensitivity;

    // Apply Friction (Stops the ball)
    dot.vx *= dot.friction;
    dot.vy *= dot.friction;

    // Position
    dot.x += dot.vx;
    dot.y += dot.vy;

    // Hard Bounds
    if (dot.x < dot.radius) { dot.x = dot.radius; dot.vx = 0; }
    if (dot.x > canvas.width - dot.radius) { dot.x = canvas.width - dot.radius; dot.vx = 0; }
    if (dot.y < dot.radius) { dot.y = dot.radius; dot.vy = 0; }
    if (dot.y > canvas.height - dot.radius) { dot.y = canvas.height - dot.radius; dot.vy = 0; }
}

function draw() {
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (!gameRunning) return;

    // Target/Safe Zone
    ctx.strokeStyle = "rgba(0, 150, 136, 0.3)";
    ctx.setLineDash([5, 5]);
    ctx.strokeRect(canvas.width/2 - 40, canvas.height/2 - 40, 80, 80);
    ctx.setLineDash([]);

    // The Ball
    ctx.shadowColor = "#00E676";
    ctx.shadowBlur = 15;
    ctx.fillStyle = "#00E676";
    ctx.beginPath();
    ctx.arc(dot.x, dot.y, dot.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();

async function startGame() {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== 'granted') return;
    }

    document.getElementById('status').textContent = "Calibrating in 1s...";
    startBtn.style.opacity = "0.5";
    startBtn.disabled = true;

    // Wait 1 second so the "tap" motion doesn't ruin the calibration
    setTimeout(() => {
        window.addEventListener("devicemotion", (e) => {
            const acc = e.accelerationIncludingGravity;
            baseGX = acc.x;
            baseGY = acc.y;
            baseGZ = acc.z;
            
            startBtn.style.display = "none";
            gameRunning = true;
            dot.x = canvas.width / 2;
            dot.y = canvas.height / 2;
            document.getElementById('status').textContent = "Running!";
            window.addEventListener("devicemotion", handleMotion);
        }, { once: true });
    }, 1000);
}

startBtn.addEventListener("click", startGame);
</script>
</body>
</html>